<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        body {
            font-family: "Poppins", sans-serif;
            background: #f3f6fb;
            color: #0f172a;
        }

        :root {
            --neon: #00e5ff;
            --semi-dark: #1e293b;
            --soft-dark: #334155;
        }

        .admin-header {
            background: var(--semi-dark);
            color: white;
            padding: 18px 24px;
            box-shadow: 0 4px 12px rgba(0, 229, 255, 0.25);
        }

        .tab-btn {
            padding: 12px 20px;
            font-weight: 600;
            color: #cbd5e1;
            border-bottom: 3px solid transparent;
            transition: 0.25s;
        }

        .tab-btn:hover {
            color: var(--neon);
        }

        .tab-active {
            color: var(--neon);
            border-bottom: 3px solid var(--neon);
        }

        .table-box {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.12);
        }

        .btn-neon {
            background: var(--neon);
            color: black;
            font-weight: 600;
            transition: .25s;
        }

        .btn-neon:hover {
            box-shadow: 0 0 10px var(--neon);
            transform: translateY(-2px);
        }

        .modal-bg {
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(3px);
        }

        .modal-box {
            background: white;
            border-radius: 14px;
            padding: 22px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.35);
        }

        input,
        textarea {
            border: 1px solid #cbd5e1;
            transition: .2s;
        }

        input:focus,
        textarea:focus {
            border-color: var(--neon);
            box-shadow: 0 0 6px rgba(0, 229, 255, .35);
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <header class="admin-header flex justify-between items-center">
        <h1 class="text-2xl font-semibold">Admin Dashboard</h1>

        <div class="flex items-center space-x-4">
            <span id="admin-info"></span>

            <button onclick="handleLogout()"
                class="px-4 py-2 rounded bg-red-500 text-white hover:bg-red-600 font-semibold">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- TABS -->
    <div class="flex space-x-6 bg-[var(--semi-dark)] px-6 py-3">
        <button id="tab-products" class="tab-btn tab-active" onclick="switchTab('products')">
            Sản phẩm
        </button>

        <button id="tab-orders" class="tab-btn" onclick="switchTab('orders')">
            Đơn hàng
        </button>
    </div>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto p-6">

        <!-- PRODUCTS SECTION -->
        <section id="section-products">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-2xl font-bold">Quản lý sản phẩm</h2>

                <button onclick="openAddProductModal()" class="btn-neon px-4 py-2 rounded">
                    + Thêm sản phẩm
                </button>
            </div>

            <div class="table-box">
                <table class="w-full">
                    <thead>
                        <tr class="text-left border-b">
                            <th class="py-2">ID</th>
                            <th class="py-2">Tên SP</th>
                            <th class="py-2">Giá</th>
                            <th class="py-2">Kho</th>
                            <th class="py-2">Danh mục</th>
                            <th class="py-2 text-center">Hành động</th>
                        </tr>
                    </thead>

                    <tbody id="product-table"></tbody>
                </table>
            </div>
        </section>

        <!-- ORDERS SECTION -->
        <section id="section-orders" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Danh sách đơn hàng</h2>

            <div class="table-box">
                <table class="w-full">
                    <thead>
                        <tr class="text-left border-b">
                            <th class="py-2">ID</th>
                            <th class="py-2">Khách</th>
                            <th class="py-2">Tổng tiền</th>
                            <th class="py-2">Địa chỉ</th>
                            <th class="py-2">SĐT</th>
                            <th class="py-2">Trạng thái</th>
                            <th class="py-2 text-center">Hành động</th>
                        </tr>
                    </thead>

                    <tbody id="order-table"></tbody>
                </table>
            </div>
        </section>

        <!-- MODAL: PRODUCT ADD/EDIT -->
        <div id="product-modal" class="modal-bg fixed inset-0 hidden flex items-center justify-center z-[1000]">
            <div class="modal-box" onclick="event.stopPropagation();">

                <h2 id="product-modal-title" class="text-xl font-bold mb-4">Thêm sản phẩm</h2>

                <form id="product-form">

                    <input type="hidden" id="product-id">

                    <label class="block font-medium">Tên sản phẩm</label>
                    <input id="product-name" class="w-full p-3 rounded mb-3" required>

                    <label class="block font-medium">Mô tả</label>
                    <textarea id="product-description" class="w-full p-3 rounded mb-3" rows="3" required></textarea>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium">Giá (VND)</label>
                            <input id="product-price" type="number" step="0.01" class="w-full p-3 rounded mb-3" required>
                        </div>

                        <div>
                            <label class="block font-medium">Tồn kho</label>
                            <input id="product-stock" type="number" class="w-full p-3 rounded mb-3" required>
                        </div>
                    </div>

                    <label class="block font-medium">Danh mục</label>
                    <input id="product-category" class="w-full p-3 rounded mb-3" required>

                    <label class="block font-medium">Ảnh sản phẩm (Upload)</label>
                    <input id="product-image-file" type="file" accept="image/*" class="w-full p-3 rounded mb-3">

                    <label class="block font-medium">Hoặc dán URL ảnh</label>
                    <input id="product-image" class="w-full p-3 rounded mb-4">

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('product-modal')"
                            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Hủy</button>

                        <button type="submit" class="btn-neon px-4 py-2 rounded">Lưu</button>
                    </div>

                </form>

            </div>
        </div>

        <!-- MODAL: ORDER DETAILS -->
        <div id="order-modal"
            class="modal-bg fixed inset-0 hidden flex items-center justify-center z-[1000]">
            <div class="modal-box max-w-2xl" onclick="event.stopPropagation();">

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Chi tiết đơn hàng</h2>
                    <button onclick="closeModal('order-modal')" class="hover:text-red-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div id="order-info" class="mb-4 text-gray-800"></div>

                <div class="border rounded-lg p-3 max-h-64 overflow-y-auto mb-4">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 text-left">Sản phẩm</th>
                                <th class="py-2 text-center">SL</th>
                                <th class="py-2 text-right">Giá</th>
                                <th class="py-2 text-right">Tổng</th>
                            </tr>
                        </thead>

                        <tbody id="order-items"></tbody>
                    </table>
                </div>

                <button id="confirm-order-btn" class="btn-neon px-4 py-2 rounded hidden">
                    Xác nhận đơn hàng
                </button>

            </div>
        </div>

        <!-- ADMIN LOGIN MODAL -->
        <div id="login-modal"
            class="modal-bg fixed inset-0 flex items-center justify-center z-[2000]">
            <div class="modal-box max-w-md text-center" onclick="event.stopPropagation();">

                <h2 class="text-2xl font-bold mb-4 text-[var(--neon)]">Đăng nhập Admin</h2>

                <form id="login-form">

                    <label class="block font-medium text-left">Tên đăng nhập</label>
                    <input id="login-username" class="w-full p-3 rounded mb-3" value="adminpharmacy">

                    <label class="block font-medium text-left">Mật khẩu</label>
                    <input id="login-password" type="password" class="w-full p-3 rounded mb-4" value="admin2003">

                    <button type="submit" class="btn-neon w-full py-3 rounded-lg">
                        Đăng nhập
                    </button>

                </form>

            </div>
        </div>

    </main>


    <!-- ============================
         SCRIPT — FULL CRUD LOGIC
    ============================= -->
    <script>
        const API = "https://pharmacy-ilgm.onrender.com";
        let adminToken = localStorage.getItem("admin_token");

        function openModal(id) {
            document.getElementById(id).classList.remove("hidden");
            if (lucide) lucide.createIcons();
        }

        function closeModal(id) {
            document.getElementById(id).classList.add("hidden");
        }

        function formatPrice(v) {
            return new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND",
            }).format(v);
        }

        function switchTab(tab) {
            document.getElementById("section-products").classList.toggle("hidden", tab !== "products");
            document.getElementById("section-orders").classList.toggle("hidden", tab !== "orders");

            document.getElementById("tab-products").classList.toggle("tab-active", tab === "products");
            document.getElementById("tab-orders").classList.toggle("tab-active", tab === "orders");

            if (tab === "products") loadProducts();
            else loadOrders();
        }

        //////////////////////////////////
        // LOGIN
        //////////////////////////////////
        document.getElementById("login-form").addEventListener("submit", adminLogin);

        async function adminLogin(e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append("username", document.getElementById("login-username").value);
            formData.append("password", document.getElementById("login-password").value);

            const res = await fetch(`${API}/auth/login`, {
                method: "POST",
                body: formData,
            });

            if (!res.ok) {
                alert("Sai tài khoản hoặc mật khẩu!");
                return;
            }

            const data = await res.json();

            adminToken = data.access_token;
            localStorage.setItem("admin_token", adminToken);

            document.getElementById("login-modal").classList.add("hidden");
            await loadAdminInfo();
            await loadProducts();

            alert("Đăng nhập thành công!");
        }

        async function loadAdminInfo() {
            const res = await fetch(`${API}/users/me`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            const user = await res.json();
            document.getElementById("admin-info").innerHTML =
                `<b>${user.full_name}</b> (${user.username})`;
        }

        function handleLogout() {
            localStorage.removeItem("admin_token");
            adminToken = null;
            openModal("login-modal");
        }

        //////////////////////////////////
        // PRODUCTS
        //////////////////////////////////

        async function loadProducts() {
            const table = document.getElementById("product-table");
            table.innerHTML = `<tr><td colspan="6" class="py-4 text-center">Đang tải...</td></tr>`;

            const res = await fetch(`${API}/products/admin`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            if (!res.ok) {
                table.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500">Không tải được sản phẩm</td></tr>`;
                return;
            }

            const products = await res.json();
            table.innerHTML = "";

            products.forEach((p) => {
                table.innerHTML += `
                <tr class="border-b">
                    <td class="py-2">${p.id}</td>
                    <td class="py-2">${p.name}</td>
                    <td class="py-2 text-[var(--neon)] font-semibold">${formatPrice(p.price)}</td>
                    <td class="py-2">${p.stock}</td>
                    <td class="py-2">${p.category}</td>

                    <td class="py-2 text-center flex justify-center gap-4">
                        <button onclick="openEditProduct(${p.id})" class="text-blue-500 hover:text-blue-700">
                            <i data-lucide="pencil"></i>
                        </button>

                        <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                </tr>
            `;
            });

            lucide.createIcons();
        }

        function openAddProductModal() {
            document.getElementById("product-modal-title").innerText = "Thêm sản phẩm";
            document.getElementById("product-form").reset();
            document.getElementById("product-id").value = "";
            openModal("product-modal");
        }

        async function openEditProduct(id) {
            const res = await fetch(`${API}/products/admin/${id}`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            const p = await res.json();

            document.getElementById("product-modal-title").innerText = `Sửa sản phẩm #${id}`;
            document.getElementById("product-id").value = id;
            document.getElementById("product-name").value = p.name;
            document.getElementById("product-description").value = p.description;
            document.getElementById("product-price").value = p.price;
            document.getElementById("product-stock").value = p.stock;
            document.getElementById("product-category").value = p.category;
            document.getElementById("product-image").value = p.image_url;

            openModal("product-modal");
        }

        document.getElementById("product-form").addEventListener("submit", saveProduct);

        async function saveProduct(e) {
            e.preventDefault();

            const id = document.getElementById("product-id").value;

            let image_url = document.getElementById("product-image").value;
            const file = document.getElementById("product-image-file").files[0];

            if (file) {
                const formUpload = new FormData();
                formUpload.append("image", file);

                const resImg = await fetch(`${API}/upload/product-image`, {
                    method: "POST",
                    headers: { Authorization: `Bearer ${adminToken}` },
                    body: formUpload,
                });

                if (!resImg.ok) {
                    alert("Upload ảnh thất bại!");
                    return;
                }

                const uploaded = await resImg.json();
                image_url = uploaded.image_url;
            }

            const productData = {
                name: document.getElementById("product-name").value,
                description: document.getElementById("product-description").value,
                price: Number(document.getElementById("product-price").value),
                stock: Number(document.getElementById("product-stock").value),
                category: document.getElementById("product-category").value,
                image_url,
            };

            const endpoint = id
                ? `${API}/products/admin/${id}`
                : `${API}/products/admin`;

            const res = await fetch(endpoint, {
                method: id ? "PUT" : "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${adminToken}`,
                },
                body: JSON.stringify(productData),
            });

            if (!res.ok) {
                alert("Lỗi lưu sản phẩm!");
                return;
            }

            closeModal("product-modal");
            loadProducts();
            alert("Đã lưu sản phẩm thành công!");
        }

        async function deleteProduct(id) {
            if (!confirm("Bạn chắc chắn muốn xóa sản phẩm này?")) return;

            const res = await fetch(`${API}/products/admin/${id}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            if (!res.ok) {
                alert("Lỗi xóa sản phẩm!");
                return;
            }

            loadProducts();
            alert("Đã xóa sản phẩm!");
        }

        //////////////////////////////////
        // ORDERS
        //////////////////////////////////

        async function loadOrders() {
            const table = document.getElementById("order-table");
            table.innerHTML = `<tr><td colspan="7" class="py-4 text-center">Đang tải...</td></tr>`;

            const res = await fetch(`${API}/admin/orders`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            const orders = await res.json();
            table.innerHTML = "";

            orders.forEach((o) => {
                table.innerHTML += `
                <tr class="border-b">
                    <td class="py-2">${o.id}</td>
                    <td class="py-2">${o.user.full_name}</td>
                    <td class="py-2 text-[var(--neon)] font-semibold">${formatPrice(o.total_amount)}</td>
                    <td class="py-2">${o.address}</td>
                    <td class="py-2">${o.phone_number}</td>

                    <td class="py-2">
                        <span class="px-3 py-1 rounded text-white 
                        ${o.payment_status === "Pending" ? "bg-yellow-500" :
                          o.payment_status === "Paid" ? "bg-blue-500" :
                          "bg-green-500"}">
                            ${o.payment_status}
                        </span>
                    </td>

                    <td class="py-2 text-center">
                        <button onclick="openOrderDetail(${o.id})" class="text-blue-500 hover:text-blue-700">
                            <i data-lucide="eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            });

            lucide.createIcons();
        }

        async function openOrderDetail(orderId) {
            const res = await fetch(`${API}/admin/orders`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            const orders = await res.json();
            const order = orders.find((o) => o.id === orderId);

            document.getElementById("order-info").innerHTML = `
            <p><b>ID:</b> #${order.id}</p>
            <p><b>Khách:</b> ${order.user.full_name}</p>
            <p><b>Địa chỉ:</b> ${order.address}</p>
            <p><b>SĐT:</b> ${order.phone_number}</p>
            <p><b>Tổng tiền:</b> <span class='text-[var(--neon)] font-semibold'>
                ${formatPrice(order.total_amount)}
            </span></p>
            <p><b>Trạng thái:</b> ${order.payment_status}</p>
        `;

            const itemsRes = await fetch(`${API}/admin/orders/${orderId}/items`, {
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            const items = await itemsRes.json();

            const tbody = document.getElementById("order-items");
            tbody.innerHTML = "";

            items.forEach((i) => {
                tbody.innerHTML += `
                <tr class="border-b">
                    <td class="py-2">${i.product_name}</td>
                    <td class="py-2 text-center">${i.quantity}</td>
                    <td class="py-2 text-right">${formatPrice(i.price_at_order)}</td>
                    <td class="py-2 text-right">${formatPrice(i.price_at_order * i.quantity)}</td>
                </tr>
            `;
            });

            const btn = document.getElementById("confirm-order-btn");

            if (order.payment_status === "Paid") {
                btn.classList.remove("hidden");
                btn.onclick = () => confirmOrder(orderId);
            } else {
                btn.classList.add("hidden");
            }

            openModal("order-modal");
        }

        async function confirmOrder(orderId) {
            const res = await fetch(`${API}/admin/orders/${orderId}/confirm`, {
                method: "POST",
                headers: { Authorization: `Bearer ${adminToken}` },
            });

            if (!res.ok) {
                alert("Lỗi xác nhận đơn!");
                return;
            }

            closeModal("order-modal");
            loadOrders();
            alert("Đã xác nhận đơn!");
        }

        //////////////////////////////////
        // INIT
        //////////////////////////////////

        document.addEventListener("DOMContentLoaded", () => {
            if (!adminToken) return;

            document.getElementById("login-modal").classList.add("hidden");
            loadAdminInfo();
            loadProducts();
        });

    </script>   

</body>
</html>

